{"version":3,"sources":["../../src/event/domain_event_storage.js"],"names":["eventConfig","get","eventStorage","require","storage","Error","configFailed","name","id","version","results","select","event_type","event_id","events","forEach","push","Object","assgin","JSON","parse","s","data","eventType","eventid","sourceid","source_id","branch","timestamp","event","inert","uuid","v1","commit","rollback"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;;;AACA;;;;;;;AAGE,oBAAc;AAAA;;AACZ,QAAIA,cAAc,iBAAOC,GAAP,CAAW,OAAX,CAAlB;AACA,QAAIC,eAAeC,eAAaH,YAAYI,OAAzB,cAAnB;AACA,QAAI,CAACF,YAAL,EACE,MAAMG,MACH,cAAIC,YADD,EAEH,mCAFG,CAAN;;AAKF,SAAKJ,YAAL,GAAoBA,YAApB;AACD;;;;;6FAEgBK,I,EAAMC,E,EAAIC,O;;;;;;AACrBC,uB;;qBACAD,O;;;;;;uBACc,KAAKP,YAAL,CAAkBS,MAAlB,CAAyB;AACvCC,8BAAYL,IAD2B;AAEvCM,4BAAUL,EAF6B;AAGvCC,2BAAS,CAAC,GAAD,EAAMA,OAAN;AAH8B,iBAAzB,C;;;AAAhBC,uB;;;;uBAMc,KAAKR,YAAL,CAAkBS,MAAlB,CAAyB;AACvCC,8BAAYL,IAD2B;AAEvCM,4BAAUL;AAF6B,iBAAzB,C;;;AAAhBE,uB;AAIII,sB,GAAS,E;;AACbJ,wBAAQK,OAAR,CAAgB,aAAK;AACnBD,yBAAOE,IAAP,CAAYC,OAAOC,MAAP,CAAcC,KAAKC,KAAL,CAAWC,EAAEC,IAAb,CAAd,EAAkC;AAC5CC,+BAAWF,EAAEd,IAD+B;AAE5CiB,6BAASH,EAAER,QAFiC;AAG5CY,8BAAUJ,EAAEK,SAHgC;AAI5CC,4BAAQN,EAAEM,MAJkC;AAK5ClB,6BAASY,EAAEZ,OALiC;AAM5CmB,+BAAWP,EAAEO;AAN+B,mBAAlC,CAAZ;AAQD,iBATD;iDAUOd,M;;;;;;;;;;;;;;;;;;;+FAGOe,K;;;;;;uBACR,KAAK3B,YAAL,CAAkB4B,KAAlB,CAAwB;AAC5BtB,sBAAIuB,KAAKC,EAAL,EADwB;AAE5BT,6BAAWM,MAAMtB,IAFW;AAG5BiB,2BAASK,MAAMrB,EAHa;AAI5BiB,4BAAUI,MAAMJ,QAJY;AAK5BH,wBAAM,0BALsB;AAM5BM,6BAAWC,MAAMD,SANW;AAO5BD,0BAAQE,MAAMF,MAPc;AAQ5BlB,2BAASoB,MAAMpB;AARa,iBAAxB,C;;;;;;;;;;;;;;;;;;;;;;;;;uBAaA,KAAKP,YAAL,CAAkB+B,MAAlB,E;;;;;;;;;;;;;;;;;;;;;;;;;uBAIA,KAAK/B,YAAL,CAAkBgC,QAAlB,E","file":"domain_event_storage.js","sourcesContent":["import config from '../config';\r\nimport err from '../err';\r\n\r\nexport default class {\r\n  constructor() {\r\n    let eventConfig = config.get('event');\r\n    let eventStorage = require(`./${eventConfig.storage}_storage`);\r\n    if (!eventStorage)\r\n      throw Error(\r\n         err.configFailed,\r\n         '事件存储服务未正确配置，可以在config/event.js中指定'\r\n      );\r\n\r\n    this.eventStorage = eventStorage;\r\n  }\r\n\r\n  async loadEvents(name, id, version) {\r\n    let results;\r\n    if (version) {\r\n      results = await this.eventStorage.select({\r\n        event_type: name,\r\n        event_id: id,\r\n        version: ['<', version]\r\n      });\r\n    }\r\n    results = await this.eventStorage.select({\r\n      event_type: name,\r\n      event_id: id\r\n    });\r\n    let events = [];\r\n    results.forEach(s => {\r\n      events.push(Object.assgin(JSON.parse(s.data), {\r\n        eventType: s.name,\r\n        eventid: s.event_id,\r\n        sourceid: s.source_id,\r\n        branch: s.branch,\r\n        version: s.version,\r\n        timestamp: s.timestamp\r\n      }));\r\n    });\r\n    return events;\r\n  }\r\n\r\n  async saveEvent(event) {\r\n    await this.eventStorage.inert({\r\n      id: uuid.v1(),\r\n      eventType: event.name,\r\n      eventid: event.id,\r\n      sourceid: event.sourceid,\r\n      data: JSON.stringify(),\r\n      timestamp: event.timestamp,\r\n      branch: event.branch,\r\n      version: event.version\r\n    });\r\n  }\r\n\r\n  async commit() {\r\n    await this.eventStorage.commit();\r\n  }\r\n\r\n  async rollback() {\r\n    await this.eventStorage.rollback();\r\n  }\r\n}\r\n"]}