{"version":3,"sources":["../../src/bus/index.js"],"names":["getDispatcher","getBus","publish","instance","type","busConfig","get","dispatcherType","dispatcher","dispatcherConfig","code","configFailed","msg","t","busType","bus","msgs","messages","length","push","name","data","message","commit"],"mappings":";;;;;;;;;;QAWgBA,a,GAAAA,a;QAyBAC,M,GAAAA,M;QAwBAC,O,GAAAA,O;;AA5DhB;;;;AAEA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;AAEA,IAAMC,WAAW,EAAjB;;AAEO,SAASH,aAAT,CAAuBI,IAAvB,EAA6B;AAClC,wBAAOA,SAAS,SAAT,IAAsBA,SAAS,OAAtC;AACA,MAAI,CAACD,SAASC,OAAO,YAAhB,CAAL,EAAoC;;AAElC,QAAMC,YAAY,iBAAOC,GAAP,CAAW,KAAX,CAAlB;;AAEA,QAAIC,iBAAiB,QAAQF,UAAUD,OAAO,YAAjB,KAAkCC,UAAUG,UAApD,MAAoE,UAApE,GAClBH,UAAUD,OAAO,YAAjB,KAAkCC,UAAUG,UAD1B,GACwC,IAD7D;;AAGA,QAAIC,mBAAmB,CAACJ,UAAUD,OAAO,YAAjB,KAAkCC,UAAUG,UAA7C,KAA4D,mBAAnF;;AAEA,QAAIA,aAAaC,mBAAmB,IAAID,UAAJ,EAAnB,GACdD,iBAAiB,IAAIA,cAAJ,EAAjB,GAAwC,IAD3C;;AAGA,QAAIC,eAAe,IAAnB,EACE,MAAM;AACJE,YAAM,cAAIC,YADN;AAEJC,WAAKR,OAAO,eAAKS,CAAL,CAAO,gCAAP;AAFR,KAAN;AAIFV,aAASC,OAAO,YAAhB,IAAgCI,UAAhC;AACD;;AAED,SAAOL,SAASC,OAAO,YAAhB,CAAP;AACD;;AAEM,SAASH,MAAT,CAAgBG,IAAhB,EAAsB;AAC3B,wBAAOA,SAAS,SAAT,IAAsBA,SAAS,OAAtC;AACF,MAAI,CAACD,SAASC,OAAO,KAAhB,CAAL,EAA6B;AAC3B,QAAMC,YAAY,iBAAOC,GAAP,CAAW,KAAX,CAAlB;;AAEA,QAAIQ,UAAU,QAAQT,UAAUD,OAAO,KAAjB,KAA2BC,UAAUD,IAA7C,MAAuD,UAAvD,GACXC,UAAUD,OAAO,KAAjB,KAA2BC,UAAUD,IAD1B,GACkC,IADhD;;AAGA,QAAIW,MAAM,CAACV,UAAUD,OAAO,KAAjB,KAA2BC,UAAUD,IAAtC,MAAgD,IAAhD,GAAuD,sBAAvD,GACR,CAACC,UAAUD,OAAO,KAAjB,KAA2BC,UAAUD,IAAtC,MAAgD,QAAhD,GAA2D,yBAAc,SAAd,EAAyBJ,cAAcI,IAAd,CAAzB,CAA3D,GACAU,UAAU,IAAIA,OAAJ,CAAY,SAAZ,EAAuBd,cAAcI,IAAd,CAAvB,CAAV,GAAwD,IAF1D;;AAIA,QAAIW,QAAQ,IAAZ,EACE,MAAM;AACJL,YAAM,cAAIC,YADN;AAEJC,WAAKR,OAAO,eAAKS,CAAL,CAAO,+BAAP;AAFR,KAAN;;AAKAV,aAASC,OAAO,KAAhB,IAAyBW,GAAzB;AACD;;AAED,SAAOZ,SAASC,OAAO,KAAhB,CAAP;AACD;;AAEM,SAASF,OAAT,CAAiBE,IAAjB,EAAoC;AACzC,wBAAOA,SAAS,SAAT,IAAsBA,SAAS,OAAtC;;AAEA,MAAIY,OAAO,EAAX;;AAHyC,oCAAVC,QAAU;AAAVA,YAAU;AAAA;;AAIzC,MAAIA,SAASC,MAAT,IAAmB,CAAnB,IAAwB,OAAOD,SAAS,CAAT,CAAP,KAAuB,QAAnD,EAA6D;AAC3DD,SAAKG,IAAL,CAAU;AACRC,YAAMH,SAAS,CAAT,CADE;AAERI,YAAMC,QAAQ,CAAR;AAFE,KAAV;AAID,GALD,MAKO;AACLN,WAAOC,QAAP;AACD;;AAED,MAAMF,MAAMd,OAAOG,IAAP,CAAZ;AACAW,MAAIb,OAAJ,6CAAec,IAAf;AACAD,MAAIQ,MAAJ;AACD","file":"index.js","sourcesContent":["import assert from 'assert';\r\n\r\nimport config from '../config';\r\nimport mqbus from './mq_bus';\r\nimport directbus from './direct_bus';\r\nimport dispatcher from './message_dispatcher';\r\nimport err from '../err';\r\nimport i18n from '../i18n';\r\n\r\nconst instance = {};\r\n\r\nexport function getDispatcher(type) {\r\n  assert(type === 'command' || type === 'event');\r\n  if (!instance[type + 'Dispatcher']) {\r\n\r\n    const busConfig = config.get('bus');\r\n\r\n    let dispatcherType = typeof (busConfig[type + 'Dispatcher'] || busConfig.dispatcher) === 'function' ?\r\n      (busConfig[type + 'Dispatcher'] || busConfig.dispatcher) : null;\r\n\r\n    let dispatcherConfig = (busConfig[type + 'Dispatcher'] || busConfig.dispatcher) == 'message_dipatcher';\r\n\r\n    var dispatcher = dispatcherConfig ? new dispatcher() :\r\n      (dispatcherType ? new dispatcherType() : null);\r\n\r\n    if (dispatcher === null)\r\n      throw {\r\n        code: err.configFailed,\r\n        msg: type + i18n.t('消息分发器未正确配置，可以在config/bus.js中指定')\r\n      };\r\n    instance[type + 'Dispatcher'] = dispatcher;\r\n  }\r\n\r\n  return instance[type + 'Dispatcher'];\r\n}\r\n\r\nexport function getBus(type) {\r\n  assert(type === 'command' || type === 'event');\r\nif (!instance[type + 'Bus']) {\r\n  const busConfig = config.get('bus');\r\n\r\n  let busType = typeof (busConfig[type + 'Bus'] || busConfig.type) === 'function' ?\r\n    (busConfig[type + 'Bus'] || busConfig.type) : null;\r\n\r\n  var bus = (busConfig[type + 'Bus'] || busConfig.type) === 'mq' ? new mqbus() :\r\n    (busConfig[type + 'Bus'] || busConfig.type) === 'direct' ? new directbus('command', getDispatcher(type)) :\r\n    busType ? new busType('command', getDispatcher(type)) : null;\r\n\r\n  if (bus === null)\r\n    throw {\r\n      code: err.configFailed,\r\n      msg: type + i18n.t('消息总线未正确配置，可以在config/bus.js中指定')\r\n    };\r\n\r\n    instance[type + 'Bus'] = bus;\r\n  }\r\n\r\n  return instance[type + 'Bus'];\r\n}\r\n\r\nexport function publish(type, ...messages) {\r\n  assert(type === 'command' || type === 'event');\r\n\r\n  let msgs = [];\r\n  if (messages.length == 2 && typeof messages[0] === 'string') {\r\n    msgs.push({\r\n      name: messages[0],\r\n      data: message[1]\r\n    });\r\n  } else {\r\n    msgs = messages;\r\n  }\r\n\r\n  const bus = getBus(type);\r\n  bus.publish(...msgs);\r\n  bus.commit();\r\n}\r\n"]}